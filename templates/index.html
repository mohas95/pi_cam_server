<!DOCTYPE html>

<html>
    <head>
        <title>Campi Server</title>

        <style>
            body{ font-family: sans-serif;}
            .controls {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap:0.5em;
                margin-top: 0.5em;
            }

            .controls label {
                margin-right: 0.3em;
            }

            .controls select, 
            .controls button {
                padding: 0.3em 0.6em;
                border-radius: 4px;
            }

            #video {
                max-width: 100%;
                height: auto;
                display: block;
                margin: 0 auto;
            }

            .video-container {
                width: 90%;
                max-width: 800px;
                margin: 0 auto;
            }

            .status {
                margin-top: 1em;
                text-align: center;
                font-size: 0.95em;
                color: #444;
                font-family: monospace;
            }

            /* Wifi Styling */
            #wifi_section {
                width: 90%;
                max-width: 800px;
                margin: 2em auto;
                padding: 1em 1.5em;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #fafafa;
            }

            #wifi_section h2 {
                text-align: center;
                margin-top: 0;
                margin-bottom: 0.8em;
                font-size: 1.4em;
                color: #333;
            }

            .wifi-controls {
                display: flex;
                flex-direction: column;
                gap: 0.8em;
            }

            .wifi-row {
                display: flex;
                flex-wrap: wrap;
                gap: 0.6em;
                align-items: center;
            }

            .wifi-row label {
                min-width: 70px;
                font-weight: bold;
            }

            .wifi-row input,
            .wifi-row select,
            .wifi-row button {
                padding: 0.4em 0.6em;
                border-radius: 4px;
                border: 1px solid #ccc;
                flex: 1;
            }

            #wifi_current_ssid {
                text-align: center;
                margin-bottom: 1em;
                font-size: 0.95em;
                font-family: monospace;
                color: #444;
            }

            button#wifi_submit,
            button#refresh_wifi {
                padding: 0.45em 0.9em;
                border-radius: 4px;
                border: none;
                background: #3c73e9;
                color: white;
                cursor: pointer;
            }

            button#refresh_wifi {
                background: #555;
            }

            button#wifi_submit:hover,
            button#refresh_wifi:hover {
                opacity: 0.9;
            }

        </style>
    </head>
    
    <body>
        <div id="current-config" class="status">
            Current: None
        </div>
        <div class="video-container">
            <img id="video" src="{{ url_for('video_feed') }}">
        </div>

        <div class="controls">
            <!-- <label for="device">Device: </label>  -->
            <select id="device">
                <option value="" disabled selected>Select device</option>
            </select>

            <!-- <label for="codec">Codec: </label>  -->
            <select id="codec">
                <option value="" disabled selected>Select codec</option>
            </select>

            <!-- <label for="resolution">Resolution: </label>  -->
            <select id="resolution">
                <option value="" disabled selected>Select resolution</option>
            </select>

            <!-- <label for="fps">FPS: </label> -->
            <select id="fps">
                <option value="" disabled selected>Select fps</option>
            </select>

            <button onclick="applyConfig()">Configure</button>

        </div>

        <h2>Wi-Fi Configuration</h2>
        <form id="wifi_form" action="{{ url_for('configure_wifi') }}" method="POST">
            <div id="current_ssid" style="margin-top: 10px; font-weight: bold;">Connected to: <span id="current_ssid">Loading...</span></div>
            
            <label for="ssid_input">SSID:</label>
            <input type="text" id="ssid_input" name="ssid" placeholder="Select or type SSID">

            <select id="wifi_dropdown">
                <option value="">-- Select a Network --</option>
            </select>

            <button type="button" id="refresh_wifi">ðŸ”„ Scan Wi-Fi</button>

            <br><br>
            <label for="wifi_password">Password:</label>
            <input type="password" id="wifi_password" name="password" placeholder="Enter Wi-Fi password">

            <br><br>
            <button type="submit">Save Wi-Fi Config</button>
        </form>        
        

        <script>
            let devices={};

            async function loadDevices(){
                const res = await fetch("/devices");
                devices = await res.json();

                const deviceSel = document.getElementById("device");
                deviceSel.innerHTML="";

                for (const [name, info] of Object.entries(devices)){
                    const opt = document.createElement("option");
                    opt.value = info.device;
                    opt.dataset.name = name;
                    opt.textContent = `${name} (${info.device})`;
                    deviceSel.appendChild(opt);
                }
                updateCodecs();
            }


            function updateCodecs(){
                const selected_device = document.getElementById("device").selectedOptions[0]
                const devName = selected_device.dataset.name;
                const devInfo = devices[devName];
                const codecSel = document.getElementById("codec");
                codecSel.innerHTML = "";

                devInfo.formats.forEach( fmt => {
                    const opt = document.createElement("option");
                    opt.value = fmt.codec;
                    opt.textContent = `${fmt.codec} (${fmt.desc})`;
                    codecSel.appendChild(opt);
                    }
                );

                updateResolutions();

            }

            function updateResolutions(){
                const selected_device = document.getElementById("device").selectedOptions[0]
                const devName = selected_device.dataset.name;
                const devInfo = devices[devName];
                const codec = document.getElementById("codec").value;
                const resSel = document.getElementById("resolution");
                resSel.innerHTML = "";

                const fmt = devInfo.formats.find(f => f.codec === codec);

                if (fmt) {
                    fmt.resolutions.forEach(r => {
                        const opt = document.createElement("option");
                        opt.value = r.resolution;
                        opt.textContent = r.resolution;
                        resSel.appendChild(opt);
                        }
                    );
                }

                updateFPS();
            }


            function updateFPS(){
                const selected_device = document.getElementById("device").selectedOptions[0]
                const devName = selected_device.dataset.name;
                const devInfo = devices[devName];
                const codec = document.getElementById("codec").value;
                const res = document.getElementById("resolution").value;
                const fpsSel = document.getElementById("fps");
                fpsSel.innerHTML = "";

                const fmt = devInfo.formats.find(f => f.codec === codec);
                const res_fmt = fmt.resolutions.find(r=> r.resolution ===res);

                if (res_fmt) {
                    res_fmt.fps.forEach(fs => {
                        const opt = document.createElement("option");
                        opt.value = fs;
                        opt.textContent = fs;
                        fpsSel.appendChild(opt);
                        }
                    );
                }
            }


            async function applyConfig() {
                const device = document.getElementById("device").value;
                const codec = document.getElementById("codec").value;
                const resolution = document.getElementById("resolution").value;
                const fps = document.getElementById("fps").value;


                await fetch("/configure",{
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({device, codec, resolution, fps})
                    }
                );

                const img = document.getElementById("video");
                img.src = "{{ url_for('video_feed') }}" + "?" + new Date().getTime();
                refreshConfig();

            }

            async function refreshConfig() {
                const res = await fetch("/current_config");
                const cfg = await res.json();
                
                document.getElementById("current-config").textContent = `Current: ${cfg.device}, ${cfg.codec}, ${cfg.width}x${cfg.height} @ ${cfg.fps}fps`;
            }


            // Wifi Functions

            async function getCurrentWiFi() {
                
                const currentElem = document.getElementById('current_ssid');
                if (!currentElem) return;

                const response = await fetch('/current_wifi');
                const data = await response.json();
                const ssid = data.ssid || 'Not connected';

                currentElem.textContent = ssid;

            }

            async function scanWiFi() {
                const dropdown = document.getElementById('wifi_dropdown');
                if(!dropdown) return;
                const response = await fetch('/scan_wifi');
                const data = await response.json();

                dropdown.innerHTML = '<option value="">-- Select a Network --</option>';
                data.networks.forEach(network => {
                    const option = document.createElement('option');
                    option.value = network.ssid;
                    option.textContent = `${network.ssid} (${network.signal}%)`;
                    dropdown.appendChild(option);
                });                
            }


            //  Camera event listers
            const deviceSel = document.getElementById("device");
            const codecSel = document.getElementById("codec");
            const resSel = document.getElementById("resolution");

            if (deviceSel){
                deviceSel.addEventListener("change", updateCodecs);
            }
            
            if (codecSel){
                codecSel.addEventListener("change", updateResolutions);
            }

            if(resSel){
                resSel.addEventListener("change", updateFPS);
            }
            

            // Wifi event listener
            const refreshBtn = document.getElementById('refresh_wifi');
            if(refreshBtn){
                refreshBtn.addEventListener('click', scanWiFi);
            }

            const wifiDropdown = document.getElementById('wifi_dropdown');
            if(wifiDropdown){
                wifiDropdown.addEventListener('change', function () {
                    const selectedSSID = this.value;
                    if (selectedSSID) {
                        const ssidInput = document.getElementById('ssid_input');
                        if (ssidInput) ssidInput.value = selectedSSID;
                    }
                });
            }

            const wifiForm = document.getElementById('wifi_form');
            if (wifiForm) {
                wifiForm.addEventListener('submit', function (e) {
                    alert("Wi-Fi settings saved. The Raspberry Pi will now restart to apply changes. Please reconnect once it's back online.");
                });
            }            

            // Initialization
            loadDevices();
            refreshConfig();
            scanWiFi();
            getCurrentWiFi();

        </script>
    </body>
</html>